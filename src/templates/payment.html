{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Payment</h2>
                    <form id="payment-form">
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount (USD)</label>
                            <input type="number" class="form-control" id="amount" value="10" min="1" step="0.01">
                        </div>
                        <div id="payment-element" class="mb-3">
                            <!-- Stripe Elements will be inserted here -->
                        </div>
                        <button id="submit" class="btn btn-primary w-100">
                            <span id="button-text">Pay now</span>
                            <span id="spinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                        <div id="payment-message" class="mt-3 text-center d-none"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    let elements;
    let paymentElement;

    document.addEventListener('DOMContentLoaded', async () => {
        const response = await fetch('/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                amount: document.getElementById('amount').value * 100
            })
        });
        const { clientSecret } = await response.json();

        elements = stripe.elements({ clientSecret });
        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');
    });

    const form = document.getElementById('payment-form');
    const submitButton = document.getElementById('submit');
    const spinner = document.getElementById('spinner');
    const buttonText = document.getElementById('button-text');
    const paymentMessage = document.getElementById('payment-message');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setLoading(true);

        const { error } = await stripe.confirmPayment({
            elements,
            confirmParams: {
                return_url: `${window.location.origin}/payment-success`,
            },
        });

        if (error) {
            paymentMessage.textContent = error.message;
            paymentMessage.classList.remove('d-none');
            setLoading(false);
        }
    });

    function setLoading(isLoading) {
        submitButton.disabled = isLoading;
        spinner.classList.toggle('d-none', !isLoading);
        buttonText.classList.toggle('d-none', isLoading);
    }
</script>
{% endblock %} 